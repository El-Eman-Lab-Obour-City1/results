<?php
// ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¹Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
error_reporting(E_ALL);
ini_set('display_errors', 1);

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
function logError($message) {
    $logFile = 'error_log.txt';
    $timestamp = date('Y-m-d H:i:s');
    file_put_contents($logFile, "[$timestamp] $message\n", FILE_APPEND);
}

$dataFile = "data.json";
$uploadDir = "uploads/";

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
if (file_exists($dataFile)) {
    $content = file_get_contents($dataFile);
    if ($content === false) {
        die(json_encode(['status' => 'error', 'message' => 'âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª']));
    }
    $patients = json_decode($content, true);
    if (json_last_error() !== JSON_ERROR_NONE) {
        die(json_encode(['status' => 'error', 'message' => 'âŒ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ù„Ù: '.json_last_error_msg()]));
    }
    
    // ÙØ±Ø² Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    usort($patients, function($a, $b) {
        $dateA = isset($a['added_date']) ? strtotime($a['added_date']) : 0;
        $dateB = isset($b['added_date']) ? strtotime($b['added_date']) : 0;
        return $dateB - $dateA;
    });
} else {
    $patients = [];
}

$message = "";
$editMode = false;
$patientToEdit = null;
$searchQuery = "";

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø­Ø«
if (isset($_GET['search'])) {
    $searchQuery = trim($_GET['search']);
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶
if (isset($_GET['delete_patient'])) {
    try {
        $phoneToDelete = $_GET['delete_patient'];
        $found = false;
        
        foreach ($patients as $index => $patient) {
            if ($patient['phone'] === $phoneToDelete) {
                // Ø­Ø°Ù Ù…Ù„ÙØ§Øª PDF Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø±ÙŠØ¶ Ø£ÙˆÙ„Ø§Ù‹
                foreach ($patient['tests'] as $test) {
                    if (file_exists($test['file'])) {
                        if (!unlink($test['file'])) {
                            logError("Failed to delete file: " . $test['file']);
                        }
                    }
                }
                // Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
                unset($patients[$index]);
                $found = true;
                break;
            }
        }
        
        if ($found) {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ù…ØµÙÙˆÙØ©
            $patients = array_values($patients);
            // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            if (file_put_contents($dataFile, json_encode($patients, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE))) {
                echo json_encode(['status' => 'success', 'message' => 'âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­']);
            } else {
                logError("Failed to save data after deletion");
                echo json_encode(['status' => 'error', 'message' => 'âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù']);
            }
        } else {
            echo json_encode(['status' => 'error', 'message' => 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙŠØ¶']);
        }
        exit();
    } catch (Exception $e) {
        logError("Delete patient error: " . $e->getMessage());
        echo json_encode(['status' => 'error', 'message' => 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶']);
        exit();
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø­Ø°Ù Ù…Ù„Ù Ù…Ø¹ÙŠÙ†
if (isset($_GET['delete_file'])) {
    try {
        $phone = $_GET['phone'];
        $fileToDelete = $_GET['delete_file'];
        $found = false;
        
        foreach ($patients as &$patient) {
            if ($patient['phone'] === $phone) {
                foreach ($patient['tests'] as $index => $test) {
                    if ($test['file'] === $fileToDelete) {
                        // Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                        if (file_exists($fileToDelete)) {
                            if (!unlink($fileToDelete)) {
                                logError("Failed to delete file: " . $fileToDelete);
                            }
                        }
                        // Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ù…Ù† Ù…ØµÙÙˆÙØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                        unset($patient['tests'][$index]);
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ù…ØµÙÙˆÙØ©
                        $patient['tests'] = array_values($patient['tests']);
                        $found = true;
                        break 2;
                    }
                }
            }
        }
        
        if ($found) {
            // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            if (file_put_contents($dataFile, json_encode($patients, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE))) {
                echo json_encode(['status' => 'success', 'message' => 'âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­']);
            } else {
                logError("Failed to save data after file deletion");
                echo json_encode(['status' => 'error', 'message' => 'âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù']);
            }
        } else {
            echo json_encode(['status' => 'error', 'message' => 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù']);
        }
        exit();
    } catch (Exception $e) {
        logError("Delete file error: " . $e->getMessage());
        echo json_encode(['status' => 'error', 'message' => 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù']);
        exit();
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶
if (isset($_GET['edit_patient'])) {
    $phoneToEdit = $_GET['edit_patient'];
    foreach ($patients as $patient) {
        if ($patient['phone'] === $phoneToEdit) {
            $patientToEdit = $patient;
            $editMode = true;
            break;
        }
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
if (isset($_GET['toggle_payment'])) {
    try {
        $phone = $_GET['toggle_payment'];
        $found = false;
        
        foreach ($patients as &$patient) {
            if ($patient['phone'] === $phone) {
                $patient['is_paid'] = !$patient['is_paid'];
                $newStatus = $patient['is_paid'];
                $found = true;
                break;
            }
        }
        
        if ($found) {
            if (file_put_contents($dataFile, json_encode($patients, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE))) {
                echo json_encode([
                    'status' => 'success', 
                    'message' => 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹',
                    'is_paid' => $newStatus,
                    'new_text' => $newStatus ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹' : 'ØªÙ… Ø§Ù„Ø¯ÙØ¹',
                    'new_class' => $newStatus ? 'btn-warning' : 'btn-success'
                ]);
            } else {
                logError("Failed to save payment status");
                echo json_encode(['status' => 'error', 'message' => 'âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹']);
            }
        } else {
            echo json_encode(['status' => 'error', 'message' => 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙŠØ¶']);
        }
        exit();
    } catch (Exception $e) {
        logError("Toggle payment error: " . $e->getMessage());
        echo json_encode(['status' => 'error', 'message' => 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹']);
        exit();
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
function formatPhoneNumber($phone) {
    try {
        $phone = preg_replace('/[^0-9]/', '', $phone);
        
        if (empty($phone)) {
            return '';
        }
        
        // Ø¥Ø°Ø§ Ø¨Ø¯Ø£ Ø§Ù„Ø±Ù‚Ù… Ø¨Ù€ 0ØŒ Ù†Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ù€ +20
        if (substr($phone, 0, 1) === '0') {
            $phone = '+20' . substr($phone, 1);
        }
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 20 Ø¨Ø¯ÙˆÙ† +ØŒ Ù†Ø¶ÙŠÙ +
        elseif (substr($phone, 0, 2) === '20') {
            $phone = '+' . $phone;
        }
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø±Ù…Ø² Ø¯ÙˆÙ„Ø© Ù…Ø·Ù„Ù‚Ø§Ù‹ØŒ Ù†Ø¶ÙŠÙ +20
        elseif (substr($phone, 0, 1) !== '+') {
            $phone = '+20' . $phone;
        }
        
        return $phone;
    } catch (Exception $e) {
        logError("Format phone error: " . $e->getMessage());
        return $phone;
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
if (isset($_GET['send_whatsapp'])) {
    try {
        $phone = $_GET['send_whatsapp'];
        $patient = null;
        
        foreach ($patients as $p) {
            if ($p['phone'] === $phone) {
                $patient = $p;
                break;
            }
        }
        
        if ($patient) {
            $whatsappNumber = formatPhoneNumber($patient['phone']);
            // ØªØºÙŠÙŠØ± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù‡Ù†Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            $message = "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ù‡ Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡\nØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒÙ…\nÙ…Ø¹Ù…Ù„ Ø§Ù„Ø§ÙŠÙ…Ø§Ù† ÙŠØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø¯ÙˆØ§Ù… Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ©\nÙŠÙˆÙ…ÙƒÙ… Ø³Ø¹ÙŠØ¯ ğŸŒ¸ğŸŒ¹ğŸŒ¸";
            $whatsappUrl = "https://wa.me/$whatsappNumber?text=" . urlencode($message);
            echo json_encode(['status' => 'redirect', 'url' => $whatsappUrl]);
        } else {
            echo json_encode(['status' => 'error', 'message' => 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙŠØ¶']);
        }
        exit();
    } catch (Exception $e) {
        logError("Whatsapp send error: " . $e->getMessage());
        echo json_encode(['status' => 'error', 'message' => 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨']);
        exit();
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø¥Ø±Ø³Ø§Ù„ SMS
if (isset($_GET['send_sms'])) {
    try {
        $phone = $_GET['send_sms'];
        $patient = null;
        $found = false;
        
        foreach ($patients as $p) {
            if ($p['phone'] === $phone) {
                $patient = $p;
                break;
            }
        }
        
        if ($patient) {
            $smsMessage = "Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ² Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ¬Ù‡ Ø§Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù…Ù„ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø£Ùˆ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‰ Ø§Ù„ Mobile App Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ù…Ù„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø®Ø§ØµÙ‡ Ø¨Ùƒ";
            
            foreach ($patients as &$p) {
                if ($p['phone'] === $phone) {
                    $p['sms_message'] = $smsMessage;
                    $p['send_sms'] = true;
                    $found = true;
                    break;
                }
            }
            
            if ($found) {
                if (file_put_contents($dataFile, json_encode($patients, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE))) {
                    echo json_encode(['status' => 'success', 'message' => 'âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø³Ø§Ù„Ø© SMS Ù„Ù„Ø§Ø±Ø³Ø§Ù„: ' . $smsMessage]);
                } else {
                    logError("Failed to save SMS data");
                    echo json_encode(['status' => 'error', 'message' => 'âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª SMS']);
                }
            }
        } else {
            echo json_encode(['status' => 'error', 'message' => 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙŠØ¶']);
        }
        exit();
    } catch (Exception $e) {
        logError("SMS send error: " . $e->getMessage());
        echo json_encode(['status' => 'error', 'message' => 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ SMS']);
        exit();
    }
}

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        if (!is_dir($uploadDir)) {
            if (!mkdir($uploadDir, 0777, true)) {
                echo json_encode(['status' => 'error', 'message' => 'âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„']);
                exit();
            }
        }

        if (!is_writable($uploadDir)) {
            echo json_encode(['status' => 'error', 'message' => 'âŒ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ÙƒØªØ§Ø¨Ø©']);
            exit();
        }

        $isPaid = isset($_POST["is_paid"]) ? (bool)$_POST["is_paid"] : false;
        $sendToWhatsapp = isset($_POST["send_to_whatsapp"]) ? true : false;
        $sendSMS = isset($_POST["send_sms"]) ? true : false;
        $smsMessage = isset($_POST["sms_message"]) ? trim($_POST["sms_message"]) : '';

        $patientName = isset($_POST["patient_name"]) ? trim($_POST["patient_name"]) : '';
        $phone = isset($_POST["phone"]) ? trim($_POST["phone"]) : '';
        $testDate = isset($_POST["test_date"]) ? $_POST["test_date"] : date('Y-m-d');

        if (empty($patientName) || empty($phone)) {
            echo json_encode(['status' => 'error', 'message' => 'âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†']);
            exit();
        }

        $files = $_FILES["pdf_files"];
        $uploadSuccess = true;
        $uploadedFiles = [];

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©
        if (isset($files['name']) && is_array($files['name'])) {
            for ($i = 0; $i < count($files['name']); $i++) {
                if ($files['error'][$i] !== UPLOAD_ERR_OK) {
                    $errorMsg = getUploadErrorMsg($files['error'][$i]);
                    echo json_encode(['status' => 'error', 'message' => 'âŒ ' . $errorMsg]);
                    exit();
                }

                $fileType = strtolower(pathinfo($files["name"][$i], PATHINFO_EXTENSION));
                if ($fileType !== "pdf") {
                    echo json_encode(['status' => 'error', 'message' => 'âŒ Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† PDF ÙÙ‚Ø·']);
                    exit();
                }

                $newFileName = preg_replace('/\s+/', '_', $patientName) . "_" . time() . "_" . $i . ".pdf";
                $destination = $uploadDir . $newFileName;

                if (!move_uploaded_file($files["tmp_name"][$i], $destination)) {
                    $error = error_get_last();
                    logError("Failed to move uploaded file: " . ($error ? $error['message'] : 'Unknown error'));
                    echo json_encode(['status' => 'error', 'message' => 'âŒ ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù']);
                    exit();
                }

                $uploadedFiles[] = [
                    "date" => $testDate,
                    "file" => $destination
                ];
            }
        }

        if ($uploadSuccess && !empty($uploadedFiles)) {
            $foundIndex = null;
            foreach ($patients as $index => $p) {
                if ($p["phone"] === $phone) {
                    $foundIndex = $index;
                    break;
                }
            }

            if ($foundIndex !== null) {
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
                $patients[$foundIndex]["name"] = $patientName;
                $patients[$foundIndex]["is_paid"] = $isPaid;
                $patients[$foundIndex]["send_to_whatsapp"] = $sendToWhatsapp;
                $patients[$foundIndex]["send_sms"] = $sendSMS;
                $patients[$foundIndex]["sms_message"] = $smsMessage;
                
                foreach ($uploadedFiles as $file) {
                    $patients[$foundIndex]["tests"][] = $file;
                }
            } else {
                $patients[] = [
                    "name" => $patientName,
                    "phone" => $phone,
                    "is_paid" => $isPaid,
                    "send_to_whatsapp" => $sendToWhatsapp,
                    "send_sms" => $sendSMS,
                    "sms_message" => $smsMessage,
                    "tests" => $uploadedFiles,
                    "added_date" => date('Y-m-d H:i:s') // Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                ];
            }

            if (file_put_contents($dataFile, json_encode($patients, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE))) {
                $response = ['status' => 'success', 'message' => 'âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'];
                
                if ($sendToWhatsapp) {
                    $whatsappNumber = formatPhoneNumber($phone);
                    // ØªØºÙŠÙŠØ± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù‡Ù†Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                    $message = "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ù‡ Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡\nØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒÙ…\nÙ…Ø¹Ù…Ù„ Ø§Ù„Ø§ÙŠÙ…Ø§Ù† ÙŠØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø¯ÙˆØ§Ù… Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ©\nÙŠÙˆÙ…ÙƒÙ… Ø³Ø¹ÙŠØ¯ ğŸŒ¸ğŸŒ¹ğŸŒ¸";
                    $whatsappUrl = "https://wa.me/$whatsappNumber?text=" . urlencode($message);
                    $response['redirect'] = $whatsappUrl;
                }
                
                echo json_encode($response);
            } else {
                logError("Failed to save patient data");
                echo json_encode(['status' => 'error', 'message' => 'âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶']);
            }
        } else {
            echo json_encode(['status' => 'error', 'message' => 'âŒ Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ Ù…Ù„ÙØ§Øª']);
        }
        exit();
    } catch (Exception $e) {
        logError("Form submission error: " . $e->getMessage());
        echo json_encode(['status' => 'error', 'message' => 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª']);
        exit();
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø§Ù„Ø±ÙØ¹
function getUploadErrorMsg($errorCode) {
    switch ($errorCode) {
        case UPLOAD_ERR_INI_SIZE:
            return 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±';
        case UPLOAD_ERR_FORM_SIZE:
            return 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬';
        case UPLOAD_ERR_PARTIAL:
            return 'ØªÙ… Ø±ÙØ¹ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø·';
        case UPLOAD_ERR_NO_FILE:
            return 'Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ Ù…Ù„Ù';
        case UPLOAD_ERR_NO_TMP_DIR:
            return 'Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø¤Ù‚Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
        case UPLOAD_ERR_CANT_WRITE:
            return 'ÙØ´Ù„ ÙÙŠ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø±Øµ';
        case UPLOAD_ERR_EXTENSION:
            return 'Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ØªÙˆÙ‚Ù Ø¨ÙˆØ§Ø³Ø·Ø© Ø¥Ø¶Ø§ÙØ©';
        default:
            return 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù';
    }
}

// ØªØµÙÙŠØ© Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ ÙˆØ¬Ø¯
$filteredPatients = $patients;
if (!empty($searchQuery)) {
    $filteredPatients = array_filter($patients, function($patient) use ($searchQuery) {
        return stripos($patient['name'], $searchQuery) !== false || 
               stripos($patient['phone'], $searchQuery) !== false;
    });
}

?>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±ÙØ¹ Ù†ØªÙŠØ¬Ø© ØªØ­Ù„ÙŠÙ„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Tajawal', sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #5a1f62 0%, #5a1f62 100%);
            color: white;
            padding: 2rem 0;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .upload-form {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        .results-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .table th {
            background-color: #f1f7fd;
            font-weight: 600;
        }
        .btn-primary {
            background-color: #ef71aa;
            border-color: #ef71aa;
        }
        .btn-primary:hover {
            background-color: #fa4c9a;
            border-color: #fa4c9a;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }